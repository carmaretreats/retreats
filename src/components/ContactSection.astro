---
import { isInputError } from "astro:actions";
import { actions } from "astro:actions";
const result = Astro.getActionResult(actions.send);
const inputErrors = isInputError(result?.error) ? result.error.fields : {};

let previousValues = {};

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    previousValues = Object.fromEntries(formData.entries());
  } catch (err) {
    console.error("Could not read form data:", err);
  }
}
---
<section
  id="kontakt"
  class="relative w-full py-20 px-6 sm:px-12 bg-cream-bg text-dark-brown font-sans"
>
  <div class="max-w-4xl mx-auto relative z-10 flex flex-col gap-16">

    <!-- Top Heading -->
    <header class="max-w-3xl">
      <p class="uppercase text-sm tracking-wide">Retreat-Infos</p>
      <h2 class="text-2xl md:text-4xl font-editorial italic leading-snug mb-6">
        Kontakt und Buchung
      </h2>
      <p class="text-base md:text-lg leading-relaxed text-dark-brown">
        Schreib uns eine Nachricht, um jetzt deinen Platz zu buchen.<br />
        Du hast noch weitere Fragen? Gerne beantworten wir dir diese — füll dazu einfach das Formular aus.
      </p>
    </header>

    <!-- ✅ Contact Form with retreatForm Alpine data -->
    <form action={actions.send} x-data="retreatForm()" class="space-y-8" method="post" novalidate>

        <!-- Retreat Selection -->
      <div class="space-y-6">
        <div>
          <label class="block mb-2 text-base font-editorial text-dark-brown">Retreat auswählen*</label>
          <div class="space-y-2">
            <label class="flex items-center gap-3 text-base text-dark-brown font-sans">
              <input
                type="radio"
                name="retreat"
                value="january"
                x-model="selectedRetreat"
                class="accent-[var(--color-accent-orange)]"
                id="send-email__retreat-january"
              />
              Hikkaduwa im Januar
            </label>
            <label class="flex items-center gap-3 text-base text-dark-brown font-sans">
              <input
                type="radio"
                name="retreat"
                value="february"
                x-model="selectedRetreat"
                class="accent-[var(--color-accent-orange)]"
                id="send-email__retreat-february"
              />
              Ahangama im Februar
            </label>
          </div>
        </div>

        <!-- Accommodation Selection -->
        <div x-show="selectedRetreat" x-cloak>
          <label class="block mb-2 text-base font-editorial text-dark-brown">Unterkunft auswählen*</label>
          <template x-for="option in accommodationOptions[selectedRetreat]" :key="option">
            <label class="flex items-center gap-3 text-base text-dark-brown font-sans">
              <input
                type="radio"
                name="accommodation"
                :value="option"
                class="accent-[var(--color-accent-orange)]"
                id="send-email__retreat-accommodation"
                />
              <span x-text="option"></span>
            </label>
          </template>
          </div>
        </div>


      <!-- Name -->
      <div>
        <label class="block mb-2 text-base font-editorial text-dark-brown">
          Ihr Name
        </label>
        <input
          type="text"
          name="name"
          value={previousValues.name || ""}
          id="send-email__name"
          placeholder="Geben Sie Ihren Namen ein"
          class="w-full text-dark-brown placeholder-dark-brown/50 rounded-none bg-white py-3 px-0 focus:outline-none focus:border-dark-brown font-sans"
          required
          aria-describedby={inputErrors.name ? "name-error" : undefined}
          />
          {
            inputErrors.name && (
            <p id="name-error" class="text-accent-orange">Bitte gib deinen Namen ein.</p>
          )
        }
      </div>

      <!-- Email -->
      <div>
        <label class="block mb-2 text-base font-editorial text-dark-brown">
          Ihre E‑Mail*
        </label>
        <input
          type="email"
          name="email"
          value={previousValues.email || ""}
          id="send-email__email"
          placeholder="Geben Sie Ihre E‑Mail-Adresse ein"
          class="w-full text-dark-brown placeholder-dark-brown/50 rounded-none bg-white py-3 px-0 focus:outline-none focus:border-dark-brown font-sans"
          required
          aria-describedby={inputErrors.email ? "email-error" : undefined}
          />
          {
          inputErrors.email && (
            <p id="email-error" class="text-accent-orange">Bitte gib eine gültige E‑Mail-Adresse ein.</p>
          )
        }
      </div>

      <!-- Message -->
      <div>
        <label class="block mb-2 text-base font-editorial text-dark-brown">
          Ihre Nachricht*
        </label>
        <textarea
          rows="5"
          placeholder="Teilen Sie uns Ihre Fragen mit"
          name="lead_message"
          id="send-email__message"
          class="w-full text-dark-brown placeholder-dark-brown/50 rounded-none bg-white py-3 px-0 resize-none focus:outline-none focus:border-dark-brown font-sans"
          >{previousValues.lead_message || ""}</textarea>
      </div>

      

      <!-- Submit Button -->
      <div class="flex justify-center pt-4">
        <button
          type="submit"
          class="inline-block w-[380px] text-center rounded-full uppercase font-sora text-white tracking-widest text-base md:text-lg px-10 py-4 shadow-md transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-cream-bg bg-[var(--color-accent-orange)] hover:bg-[#bb421d] focus:ring-[var(--color-accent-orange)]"
        >
          Deine Frage schicken
        </button>
      </div>

    </form>
  </div>
</section>
{Object.keys(inputErrors).length > 0 && (
  <script>
    window.location.hash = "#kontakt";
  </script>
)}