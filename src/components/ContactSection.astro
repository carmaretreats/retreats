---
import { isInputError } from "astro:actions";
import { actions } from "astro:actions";

const result = Astro.getActionResult(actions.send);
const inputErrors = isInputError(result?.error) ? result.error.fields : {};

let previousValues = {};
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    previousValues = Object.fromEntries(formData.entries());
  } catch (err) {
    console.error("Could not read form data:", err);
  }
}
---

<section id="kontakt" class="relative section bg-cream-bg text-black font-sans">
  <div class="section-inner relative z-10">

    <!-- üè∑Ô∏è SECTION LABEL + TITLE -->
    <div class="max-w-3xl mb-8">
      <p class="uppercase section-label mb-8">Retreat-Infos</p>
      <h2 style="font-family: 'EditorialOld', sans-serif; font-style: italic;" class="heading-main mb-6">
        Kontakt und Buchung
      </h2>
    </div>

    <!-- üß≠ GRID: Paragraph left / Form right -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 lg:gap-20 items-start">
      
      <!-- üìù LEFT COLUMN ‚Äî Paragraph -->
      <div class="max-w-lg">
        <p class="body-text text-black">
          Schreib uns eine Nachricht, um jetzt deinen Platz zu buchen.<br />
          Du hast noch weitere Fragen? Gerne beantworten wir dir diese ‚Äì f√ºll dazu einfach das Formular aus.
          Wir freuen uns, von Dir zu h√∂ren.
        </p>
      </div>

      <!-- üì® RIGHT COLUMN ‚Äî Form -->
      <form action={actions.send} x-data="retreatForm()" @submit="localStorage.removeItem('selectedRetreat')" method="post" novalidate class="space-y-8">
        <!-- Retreat Selection -->
        <div class="space-y-4">
          <label class="block mb-2 font-garamond italic text-xl md:text-2xl leading-[1.2] text-black">
            Retreat ausw√§hlen
          </label>
          <div class="space-y-2">
            <label class="flex items-center gap-3 font-sans text-[14px] xs:text-[14px] md:text-[18px] leading-[1.4]">
              <input
                type="radio"
                name="retreat"
                value="january"
                x-model="selectedRetreat"
                class="accent-[var(--color-accent-orange)]"
              />
              Hikkaduwa im Januar
            </label>
            <label class="flex items-center gap-3 font-sans text-[14px] xs:text-[14px] md:text-[18px] leading-[1.4]">
              <input
                type="radio"
                name="retreat"
                value="february"
                x-model="selectedRetreat"
                class="accent-[var(--color-accent-orange)]"
              />
              Ahangama im Februar
            </label>
          </div>
        </div>

        <div x-show="selectedRetreat" x-cloak>
          <label class="block mb-2 font-garamond italic text-xl md:text-2xl leading-[1.2] text-black">
            Unterkunft ausw√§hlen*
          </label>
          <template x-for="option in accommodationOptions[selectedRetreat]" :key="option">
            <label class="flex items-center gap-3 font-sans text-[14px] xs:text-[14px] md:text-[18px] leading-[1.4]">
              <input
                type="radio"
                name="accommodation"
                :value="option"
                class="accent-[var(--color-accent-orange)]"
              />
              <span x-text="option"></span>
            </label>
          </template>
        </div>

        <!-- Name -->
        <div>
          <label class="block mb-2 font-garamond italic text-xl md:text-2xl leading-[1.2] text-black">
            Dein Name*
          </label>
          <input
            type="text"
            name="name"
            value={previousValues.name || ""}
            placeholder="Gib hier deinen Namen an"
            class="w-full text-black placeholder-black/50 bg-white border-b border-black py-3 focus:outline-none focus:border-accent-orange font-sans text-[14px] xs:text-[14px] md:text-[18px] leading-[1.4]"
            aria-describedby={inputErrors.name ? "name-error" : undefined}
            required
          />
          {inputErrors.name && (
            <p id="name-error" class="text-accent-orange mt-1 text-sm">Bitte gib deinen Namen ein.</p>
          )}
        </div>

        <!-- Email -->
        <div>
          <label class="block mb-2 font-garamond italic text-xl md:text-2xl leading-[1.2] text-black">
            Deine E-Mail*
          </label>
          <input
            type="email"
            name="email"
            value={previousValues.email || ""}
            placeholder="Gib hier deine E-Mail-Adresse ein"
            class="w-full text-black placeholder-black/50 bg-white border-b border-black py-3 focus:outline-none focus:border-accent-orange font-sans text-[14px] xs:text-[14px] md:text-[18px] leading-[1.4]"
            aria-describedby={inputErrors.email ? "email-error" : undefined}
            required
          />
          {inputErrors.email && (
            <p id="email-error" class="text-accent-orange mt-1 text-sm">Bitte gib eine g√ºltige E-Mail-Adresse ein.</p>
          )}
        </div>

        <!-- Message -->
        <div>
          <label class="block mb-2 font-garamond italic text-xl md:text-2xl leading-[1.2] text-black">
            Deine Nachricht
          </label>
          <textarea
            rows="5"
            name="lead_message"
            placeholder="Schreib uns hier, um deinen Platz zu buchen oder wenn du weitere Fragen hast."
            class="w-full text-black placeholder-black/50 bg-white border-b border-black py-3 resize-none focus:outline-none focus:border-accent-orange font-sans text-[14px] xs:text-[14px] md:text-[18px] leading-[1.4]"
          >{previousValues.lead_message || ""}</textarea>
        </div>

        <!-- Submit Button -->
        <div>
          <button
            type="submit"
            class="inline-block w-full md:w-auto text-center rounded-full uppercase font-sora text-white tracking-widest text-base md:text-lg px-10 py-4 shadow-md transition-colors duration-300 bg-[var(--color-accent-orange)] hover:bg-[#bb421d] focus:ring-2 focus:ring-[var(--color-accent-orange)] focus:ring-offset-2 focus:ring-offset-cream-bg"
          >
            Nachricht senden
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

{Object.keys(inputErrors).length > 0 && (
  <script>
    window.location.hash = "#kontakt";
  </script>
)}